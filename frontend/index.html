    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="/js/themes/default/easyui.css">
        <link rel="stylesheet" type="text/css" href="/js/themes/icon.css">
        <link rel="stylesheet" type="text/css" href="/js/demo/demo.css">
        <link rel="stylesheet" type="text/css" href="waq.css">
        <script type="text/javascript" src="/js/jquery.min.js"></script>
        <script type="text/javascript" src="/js/jquery.easyui.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pollution Sensors</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">

    </head>

    <body>
        <h2>Pollution Sensors</h2>
        
        <!-- <div style="margin:20px 0;"></div> -->
        <div class="easyui-layout" style="width:1200px;height:500px;margin:20px">
          
            <div data-options="region:'south',split:true" style= "height:27px;text-align:right;padding-right:10px">
            <a href=humans.txt><img src="http://humanstxt.org/img/oficial-logos/humanstxt-isolated-blank.gif" alt="Humans.txt Icon" style="height:22px;"></a>
            </div>
            
            <div data-options="region:'east',split:true" title="Pollution Levels in This Area" style= "width:30%">
                <div data-options="region:'north'" style="height:25px">
                      <form>
                        <input id="pac-input" class="controls" size=100 type="text" placeholder="Enter Search Location">
                      </form>
                </div>
                
                <div class="easyui-tabs" border="false">
                  
                    <div title="Overview" style="padding:10px;" closable="false" plain="true" border="false">
                        
                        <div class=container> 
                            <p>
                                <img src="http://nwgbusiness.co.uk/content/uploads/2015/10/icon-water.png" alt="Water Quality Icon" style="width:75px;height:75px;display:block;margin-left: auto;margin-right:auto">
                             Water Quality: Wet
                             </p>
                        </div>

                        <div class=container>
                            <p>

                                <img src="http://nwgbusiness.co.uk/content/uploads/2015/10/icon-air.png" alt="Air Quality Icon" style="width:75px;height:75px;display:block;margin-left: auto;margin-right:auto">
                                Air Quality: Fetored
                            </p>

                        </div>


                    </div>
                    <div title="Categorical View" closable="false" plain="true" border="false" style="padding:10px;"></div>
                    <div title="Constituent View" closable="false" style="padding:10px;" plain="true" border="false"></div>
                </div>
            </div>
            <!-- <div id="map" data-options="region:'west',split:true,collapsible:true" title="West" style="width:50%;"></div> -->
            <div id="map" data-options="region:'center',title:'Google Cartogram',collapsible:true">

            <!-- Search Bar -->
            <input id="pac-input" class="controls" size=80 type="text" placeholder="Enter Search Location">
            <!-- center: {lat: 37.871667, lon: -122.272778} -->
                
            <script>
                function initMap() {

                    var myLatLng = {lat: 37.871667, lng: -122.272778};

                    var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 11,
                    scaleControl: true,
                    center: myLatLng
                    });

                    var input = document.getElementById('pac-input');
                    var searchBox = new google.maps.places.SearchBox(input);
                    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

                    // Bias the SearchBox results towards current map's viewport.
                    map.addListener('bounds_changed', function() {
                      searchBox.setBounds(map.getBounds());
                    });

                    var markers = [];
                    // Listen for the event fired when the user selects a prediction and retrieve
                    // more details for that place.
                    searchBox.addListener('places_changed', function() {
                          var places = searchBox.getPlaces();

                          if (places.length == 0) {
                            return;
                          }

                          // Clear out the old markers.
                          markers.forEach(function(marker) {
                            marker.setMap(null);
                          });
                          markers = [];

                          // For each place, get the icon, name and location.
                          var bounds = new google.maps.LatLngBounds();
                          places.forEach(function(place) {
                            if (!place.geometry) {
                              console.log("Returned place contains no geometry");
                              return;
                            }
                            var icon = {
                              // url: place.icon,  //This edit keeps the normal markers;  the place icons are weird
                              size: new google.maps.Size(71, 71),
                              origin: new google.maps.Point(0, 0),
                              anchor: new google.maps.Point(17, 34),
                              scaledSize: new google.maps.Size(25, 25)
                            };

                            // Create a marker for each place.
                            markers.push(new google.maps.Marker({
                              map: map,
                              icon: icon,
                              title: place.name,
                              position: place.geometry.location
                            }));

                            if (place.geometry.viewport) {
                              // Only geocodes have viewport.
                              bounds.union(place.geometry.viewport);
                            } else {
                              bounds.extend(place.geometry.location);
                            }
                          });
                          map.fitBounds(bounds);
                        });



                  var marker = new google.maps.Marker({
                    position: myLatLng,
                    map: map,
                    title: 'Hello World!'
                  });

                  google.maps.event.addListener(map, 'bounds_changed', 
                  function() {
                    var bounds = map.getBounds();
                    //alert(bounds);
                    var ne = bounds.getNorthEast(); // LatLng of the north-east corner
                    var sw = bounds.getSouthWest(); // LatLng of the south-west corder
                    var nw = new google.maps.LatLng(ne.lat(), sw.lng());
                    var se = new google.maps.LatLng(sw.lat(), ne.lng());
                    var sms = fetchSites(ne,sw,map);
                    console.log();
                  });
                 


                }; //end of initMap

                function fetchSites(ne,sw,map) {
                    // REST Query Structure: 
                    //     /getWaterSites/:SWLat/:SWLon/:NELat/:NELon
                    //     http://130.211.86.94:8080/getWaterSites/34.80/-117.040/34.99/-117.050

                    var water_api_url = "http://130.211.86.94:8080/getWaterSites/";
                    //water_api_url += sw.lat() + '/' + sw.lng() + '/' + ne.lat() + '/' + ne.lng();
                    water_api_url += sw.lat() + '/' + ne.lng() + '/' + ne.lat() + '/' + sw.lng();
                    console.log(water_api_url);

                    var sensorMarkers = [];

                    $.getJSON(water_api_url, function(data) {
                    //data is the JSON string
                        console.log('Number of return datapoints: '+data.length)
                        var image = 'http://findicons.com/files/icons/1156/fugue/16/water.png';

                        // loop through each point returned from the API
                        $.each(data,function(datapoint){
                            var thisLatLng = {lat: Number(data[datapoint].LatitudeMeasure), lng: Number(data[datapoint].LongitudeMeasure)};
                            console.log(thisLatLng);
                            var thismarker = new google.maps.Marker({
                                position: thisLatLng,
                                map: map,
                                icon: image,
                                title: data[datapoint].MonitoringLocationTypeName + '\n' + data[datapoint].MonitoringLocationIdentifier + '\n' + data[datapoint].MonitoringLocationName
                                //title: "Bork!"
                            });
                            //console.log('Pushing point')
                            sensorMarkers.push(thismarker);
                        });
                    });

                // Add a marker clusterer to manage the markers.
                var markerCluster = new MarkerClusterer(map, sensorMarkers,
                    {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
                
                return sensorMarkers;

                }  // end of function fetchSites

                
                </script>

            <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATqp-SH3dfKTkATjFfw1MuYeEzs_JeO9E&callback=initMap" async defer> -->
            <!-- </script> -->
            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATqp-SH3dfKTkATjFfw1MuYeEzs_JeO9E&callback&libraries=places&callback=initMap" async defer></script>

  </body>
</html>
                

            </div>

            </div>
    </body>
    </html>
